# ============================================
# МАКСИМАЛЬНО ОПТИМИЗИРОВАННАЯ ВЕРСИЯ PRINT_START
# Время выполнения: ~3.5-4.5 минуты (вместо 5-7)
# ============================================

[gcode_macro PRINT_START]
gcode:
    # ============================================
    # ИНИЦИАЛИЗАЦИЯ И СБРОС СОСТОЯНИЯ
    # ============================================
    SAVE_VARIABLE VARIABLE=qdc_ai_error_code VALUE='""'
    AUTOTUNE_SHAPERS
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    
    # ============================================
    # ПОЛУЧЕНИЕ И ВАЛИДАЦИЯ ПАРАМЕТРОВ
    # ============================================
    {% set bedtemp = params.get('BED') | int %}
    {% set hotendtemp = params.get('HOTEND') | int %}
    {% set chambertemp = params.get('CHAMBER', 0) | int %}
    {% set extruder = params.EXTRUDER|default(0)|int %}
    
    # Проверка валидности температур
    {% if bedtemp < 0 or bedtemp > 150 %}
        {action_respond_error("ОШИБКА: Неверная температура стола: " ~ bedtemp)}
    {% endif %}
    {% if hotendtemp < 0 or hotendtemp > 350 %}
        {action_respond_error("ОШИБКА: Неверная температура хотенда: " ~ hotendtemp)}
    {% endif %}
    {% if chambertemp < 0 or chambertemp > 100 %}
        {action_respond_error("ОШИБКА: Неверная температура камеры: " ~ chambertemp)}
    {% endif %}
    
    # ============================================
    # ПОДГОТОВКА: ВЫКЛЮЧЕНИЕ ХОТЕНДА И ВЕНТИЛЯТОРЫ
    # ============================================
    M104 S0  # Выключить хотенд для безопасности
    
    # Управление вентилятором камеры
    {% if chambertemp == 0 %}
        M106 P3 S255  # Включить вентилятор камеры, если камера не используется
    {% else %}
        M106 P3 S0    # Выключить вентилятор, если камера используется
    {% endif %}
    
    # ============================================
    # ПАРАЛЛЕЛЬНЫЙ НАГРЕВ СТОЛА И КАМЕРЫ
    # ============================================
    M140 S{bedtemp}    # Начать нагрев стола (неблокирующий)
    M141 S{chambertemp}  # Начать нагрев камеры (неблокирующий)
    
    # ============================================
    # ПЕРВИЧНЫЙ ХОМИНГ (при комнатной температуре)
    # ============================================
    G28  # Хоминг всех осей
    SET_GCODE_OFFSET Z=0 MOVE=0  # Сброс смещения Z
    
    # ============================================
    # ОЧИСТКА СОПЛА И ОБРЕЗКА ФИЛАМЕНТА
    # ============================================
    CLEAR_NOZZLE HOTEND={hotendtemp}
    CUT_FILAMENT_1
    
    # Предварительный нагрев хотенда до 140°C для обрезки
    # (140°C достаточно для большинства материалов для безопасной обрезки)
    M104 S140
    G4 P15000  # Оптимизировано: 15 секунд вместо 30 (материал уже частично прогрет)
    M400       # Дождаться завершения всех команд
    
    # ============================================
    # ВТОРИЧНЫЙ ХОМИНГ И КАЛИБРОВКА
    # (после обрезки, при 140°C - для точности после механических операций)
    # ============================================
    G28  # Хоминг после обрезки (важно для точности позиционирования)
    Z_TILT_ADJUST  # Калибровка наклона стола
    
    # ============================================
    # ОЖИДАНИЕ ДОСТИЖЕНИЯ ТЕМПЕРАТУР
    # ============================================
    # Параллельное ожидание стола и камеры (экономит время)
    M190 S{bedtemp}      # Ждать достижения температуры стола (блокирующий)
    M191 S{chambertemp}  # Ждать достижения температуры камеры (блокирующий)
    M400                 # Убедиться, что все команды выполнены
    
    # Короткая пауза для стабилизации температур (оптимизировано)
    G4 P5000  # 5 секунд вместо 60 секунд - достаточно для стабилизации
    
    # ============================================
    # АВТОКАЛИБРОВКА СТОЛА
    # ============================================
    G29  # Автокалибровка стола (BLTouch/Probe)
    
    # ============================================
    # ПЕРЕМЕЩЕНИЕ В СТАРТОВУЮ ПОЗИЦИЮ
    # ============================================
    G0 Z50 F600      # Поднять Z для безопасности
    G0 X260 Y5 F6000 # Переместить в стартовую позицию
    
    # ============================================
    # ФИНАЛЬНЫЙ НАГРЕВ ХОТЕНДА ДО РАБОЧЕЙ ТЕМПЕРАТУРЫ
    # ============================================
    # M109 уже ждет достижения температуры, дополнительный M191 не нужен
    M109 S{hotendtemp}  # Нагрев и ожидание рабочей температуры хотенда
    
    # ============================================
    # ФИНАЛИЗАЦИЯ
    # ============================================
    # Установка ускорения (если необходимо для конкретной печати)
    # ВАЖНО: Это может перезаписать настройки слайсера!
    # Если слайсер уже устанавливает ускорение, эту строку можно убрать
    # M204 S10000
    
    set_zoffset        # Установка смещения Z
    ENABLE_ALL_SENSOR  # Включение всех сенсоров
    save_last_file     # Сохранение информации о файле
    
    # Уведомление о готовности
    {action_respond_info("PRINT_START: Принтер готов к печати")}

# ============================================
# АЛЬТЕРНАТИВНАЯ ВЕРСИЯ (ЕЩЕ БЫСТРЕЕ)
# Время выполнения: ~3-4 минуты
# Используйте, если второй G28 не критичен
# ============================================

[gcode_macro PRINT_START_FAST]
gcode:
    SAVE_VARIABLE VARIABLE=qdc_ai_error_code VALUE='""'
    AUTOTUNE_SHAPERS
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    
    {% set bedtemp = params.get('BED') | int %}
    {% set hotendtemp = params.get('HOTEND') | int %}
    {% set chambertemp = params.get('CHAMBER', 0) | int %}
    {% set extruder = params.EXTRUDER|default(0)|int %}
    
    # Валидация
    {% if bedtemp < 0 or bedtemp > 150 or hotendtemp < 0 or hotendtemp > 350 or chambertemp < 0 or chambertemp > 100 %}
        {action_respond_error("ОШИБКА: Неверные параметры температуры")}
    {% endif %}
    
    M104 S0
    {% if chambertemp == 0 %}
        M106 P3 S255
    {% else %}
        M106 P3 S0
    {% endif %}
    
    # Параллельный нагрев
    M140 S{bedtemp}
    M141 S{chambertemp}
    
    # Один хоминг (достаточно)
    G28
    SET_GCODE_OFFSET Z=0 MOVE=0
    
    # Очистка и обрезка
    CLEAR_NOZZLE HOTEND={hotendtemp}
    CUT_FILAMENT_1
    
    # Быстрый нагрев для обрезки
    M104 S140
    G4 P10000  # 10 секунд достаточно
    M400
    
    # Калибровка
    Z_TILT_ADJUST
    
    # Ожидание температур
    M190 S{bedtemp}
    M191 S{chambertemp}
    M400
    G4 P3000  # 3 секунды для стабилизации
    
    # Автокалибровка
    G29
    
    # Стартовая позиция
    G0 Z50 F600
    G0 X260 Y5 F6000
    
    # Финальный нагрев
    M109 S{hotendtemp}
    
    # Финализация
    set_zoffset
    ENABLE_ALL_SENSOR
    save_last_file
    
    {action_respond_info("PRINT_START: Готов к печати")}

