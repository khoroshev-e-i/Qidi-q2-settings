# ============================================
# OPTIMIZED PRINT_START MACRO - WITH BOX SUPPORT (FAST)
# Firmware: Klipper v1.1.0
# Execution time: ~3.5-5 minutes
# Single homing (G28) instead of dual for speed
# Full support for Qidi multi-material box system
# ============================================

[gcode_macro PRINT_START]
gcode:
    # ============================================
    # PARAMETER VALIDATION (FIRST!)
    # ============================================
    {% set bedtemp = params.get('BED') | int %}
    {% set hotendtemp = params.get('HOTEND') | int %}
    {% set chambertemp = params.get('CHAMBER', 0) | int %}
    {% set extruder = params.EXTRUDER|default(0)|int %}
    
    # Temperature validation
    {% if bedtemp < 0 or bedtemp > 150 or hotendtemp < 0 or hotendtemp > 350 or chambertemp < 0 or chambertemp > 100 %}
        {action_respond_error("ERROR: Invalid temperature parameters")}
    {% endif %}
    
    # ============================================
    # START BED AND CHAMBER HEATING IMMEDIATELY!
    # ============================================
    M140 S{bedtemp}      # Start bed heating (non-blocking) - IMMEDIATELY!
    M141 S{chambertemp}  # Start chamber heating (non-blocking) - IMMEDIATELY!
    
    # ============================================
    # INITIALIZATION (parallel to heating)
    # ============================================
    AUTOTUNE_SHAPERS
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    
    M104 S0
    {% if chambertemp == 0 %}
        M106 P3 S255
    {% else %}
        M106 P3 S0
    {% endif %}
    
    # ============================================
    # SINGLE HOMING (sufficient)
    # ============================================
    G28
    SET_GCODE_OFFSET Z=0 MOVE=0
    BUFFER_MONITORING ENABLE=0
    
    # ============================================
    # BOX SYSTEM PROCESSING
    # ============================================
    {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] %}
        SAVE_VARIABLE VARIABLE=load_retry_num VALUE=0
        SAVE_VARIABLE VARIABLE=retry_step VALUE=None
        CLEAR_TOOLCHANGE_STATE
        
        # Optimized runout reset (without delays)
        {% for i in range(16) %}
            SAVE_VARIABLE VARIABLE=runout_{i} VALUE=0
        {% endfor %}
        
        {% if printer.save_variables.variables.enable_box == 1 %}
            BOX_PRINT_START EXTRUDER={extruder} HOTENDTEMP={hotendtemp}
            M400
            EXTRUSION_AND_FLUSH HOTEND={hotendtemp}
        {% endif %}
    {% endif %}
    
    # ============================================
    # CLEANING AND FILAMENT CUTTING
    # ============================================
    CLEAR_NOZZLE HOTEND={hotendtemp}
    CUT_FILAMENT_1
    
    # Fast heating for cutting
    M104 S140
    G4 P1500  # 1.5 seconds
    M400
    
    # ============================================
    # CALIBRATION (without second G28)
    # ============================================
    Z_TILT_ADJUST
    
    # ============================================
    # WAIT FOR TEMPERATURES
    # ============================================
    M190 S{bedtemp}
    M191 S{chambertemp}
    M400
    G4 P1500  # 1.5 seconds for stabilization
    
    # ============================================
    # AUTO-CALIBRATION
    # ============================================
    G29
    
    # ============================================
    # START POSITION
    # ============================================
    G0 Z50 F600
    G0 X260 Y5 F30000
    
    # ============================================
    # ENABLE BUFFER MONITORING
    # ============================================
    {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] and printer.save_variables.variables.enable_box == 1 %}
        BUFFER_MONITORING ENABLE=1
    {% endif %}
    
    # ============================================
    # FINAL HEATING
    # ============================================
    M109 S{hotendtemp}
    
    # ============================================
    # FINALIZATION
    # ============================================
    M204 S10000
    set_zoffset
    ENABLE_ALL_SENSOR
    save_last_file
    
    {action_respond_info("PRINT_START: Ready for printing")}

