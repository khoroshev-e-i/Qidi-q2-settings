# ============================================
# OPTIMIZED PRINT_START MACRO - WITH BOX SUPPORT
# Firmware: Klipper v1.1.0
# Execution time: ~3.5-5.5 minutes (instead of 5-8)
# 
# KEY OPTIMIZATIONS:
# - Bed (M140) and chamber (M141) heating starts IMMEDIATELY at the beginning
# - Bed heats in parallel with G28, cleaning, calibration, etc.
# - By the time M190 executes, bed is already ready → saves 30-90 seconds!
# - Full support for Qidi multi-material box system
# ============================================

[gcode_macro PRINT_START]
gcode:
    # ============================================
    # PARAMETER VALIDATION (FIRST!)
    # ============================================
    {% set bedtemp = params.get('BED') | int %}
    {% set hotendtemp = params.get('HOTEND') | int %}
    {% set chambertemp = params.get('CHAMBER', 0) | int %}
    {% set extruder = params.EXTRUDER|default(0)|int %}
    
    # Temperature validation
    {% if bedtemp < 0 or bedtemp > 150 %}
        {action_respond_error("ERROR: Invalid bed temperature: " ~ bedtemp)}
    {% endif %}
    {% if hotendtemp < 0 or hotendtemp > 350 %}
        {action_respond_error("ERROR: Invalid hotend temperature: " ~ hotendtemp)}
    {% endif %}
    {% if chambertemp < 0 or chambertemp > 100 %}
        {action_respond_error("ERROR: Invalid chamber temperature: " ~ chambertemp)}
    {% endif %}
    
    # ============================================
    # START BED AND CHAMBER HEATING IMMEDIATELY!
    # (Parallel to other operations - saves time)
    # ============================================
    M140 S{bedtemp}      # Start bed heating (non-blocking) - IMMEDIATELY!
    M141 S{chambertemp}  # Start chamber heating (non-blocking) - IMMEDIATELY!
    
    # ============================================
    # INITIALIZATION AND STATE RESET
    # (Executes in parallel with bed heating)
    # ============================================
    AUTOTUNE_SHAPERS
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    
    # ============================================
    # PREPARATION: HOTEND OFF AND FANS
    # ============================================
    M104 S0  # Turn off hotend for safety
    
    # Chamber fan control
    {% if chambertemp == 0 %}
        M106 P3 S255  # Turn on chamber fan if chamber is not used
    {% else %}
        M106 P3 S0    # Turn off fan if chamber is used
    {% endif %}
    
    # ============================================
    # PRIMARY HOMING
    # ============================================
    G28  # Home all axes
    SET_GCODE_OFFSET Z=0 MOVE=0  # Reset Z offset
    
    # ============================================
    # DISABLE BUFFER MONITORING
    # ============================================
    BUFFER_MONITORING ENABLE=0
    
    # ============================================
    # BOX SYSTEM PROCESSING
    # ============================================
    {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] %}
        # Reset retry variables
        SAVE_VARIABLE VARIABLE=load_retry_num VALUE=0
        SAVE_VARIABLE VARIABLE=retry_step VALUE=None
        CLEAR_TOOLCHANGE_STATE
        
        # Reset runout variables for all boxes (optimized)
        {% for i in range(16) %}
            SAVE_VARIABLE VARIABLE=runout_{i} VALUE=0
            {% if not loop.last %}
                G4 P10  # Reduced from 100ms to 10ms (saves ~1.4 sec)
            {% endif %}
        {% endfor %}
        
        # Start box system if enabled
        {% if printer.save_variables.variables.enable_box == 1 %}
            BOX_PRINT_START EXTRUDER={extruder} HOTENDTEMP={hotendtemp}
            M400
            EXTRUSION_AND_FLUSH HOTEND={hotendtemp}
        {% endif %}
    {% endif %}
    
    # ============================================
    # NOZZLE CLEANING AND FILAMENT CUTTING
    # ============================================
    CLEAR_NOZZLE HOTEND={hotendtemp}
    # Filament cutting and leveling
    CUT_FILAMENT_1
    
    # Pre-heat hotend to 140°C for cutting
    M104 S140
    G4 P2000  # Optimized: 2 seconds instead of 3 (material already partially heated)
    M400       # Wait for all commands to complete
    
    # ============================================
    # SECONDARY HOMING AND CALIBRATION
    # (after cutting, at 140°C - for precision after mechanical operations)
    # ============================================
    G28  # Home after cutting (important for positioning accuracy)
    Z_TILT_ADJUST  # Bed tilt calibration
    
    # ============================================
    # WAIT FOR TEMPERATURES
    # ============================================
    # Parallel waiting for bed and chamber (saves time)
    # M104 S140 already set above, no need to duplicate
    M190 S{bedtemp}      # Wait for bed temperature (blocking)
    M191 S{chambertemp}  # Wait for chamber temperature (blocking)
    M400                 # Ensure all commands are executed
    
    # Short pause for temperature stabilization (optimized)
    G4 P2000  # 2 seconds instead of 3 - sufficient for stabilization
    
    # ============================================
    # BED AUTO-CALIBRATION
    # ============================================
    G29  # Bed auto-calibration (BLTouch/Probe)
    
    # ============================================
    # MOVE TO START POSITION
    # ============================================
    G0 Z50 F600      # Raise Z for safety
    G0 X260 Y5 F30000  # Move to start position (optimized: F30000 instead of F6000)
    
    # ============================================
    # ENABLE BUFFER MONITORING (if needed)
    # ============================================
    {% if printer.save_variables.variables.box_count >= 1 and printer["box_extras"] and printer.save_variables.variables.enable_box == 1 %}
        BUFFER_MONITORING ENABLE=1
    {% endif %}
    
    # ============================================
    # FINAL HOTEND HEATING TO WORKING TEMPERATURE
    # ============================================
    # M109 already waits for temperature, additional M191 not needed
    # But if chamber is critical, can leave M191 before M109
    M191 S{chambertemp}  # Wait for chamber temperature (if critical)
    M109 S{hotendtemp}   # Heat and wait for hotend working temperature
    
    # ============================================
    # FINALIZATION
    # ============================================
    # Acceleration setting (if needed for specific print)
    # IMPORTANT: This may overwrite slicer settings!
    # If slicer already sets acceleration, this line can be removed
    M204 S10000
    
    set_zoffset        # Set Z offset
    ENABLE_ALL_SENSOR  # Enable all sensors
    save_last_file     # Save file information
    
    # Ready notification
    {action_respond_info("PRINT_START: Printer ready for printing")}

