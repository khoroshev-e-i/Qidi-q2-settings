# ============================================
# OPTIMIZED PRINT_START MACRO - BASIC VERSION
# Firmware: Klipper v1.1.0
# Execution time: ~3.5-4.5 minutes (instead of 5-7)
# 
# KEY OPTIMIZATIONS:
# - Bed (M140) and chamber (M141) heating starts IMMEDIATELY at the beginning
# - Bed heats in parallel with G28, cleaning, calibration, etc.
# - By the time M190 executes, bed is already ready → saves 30-90 seconds!
# ============================================

[gcode_macro PRINT_START]
gcode:
    # ============================================
    # PARAMETER VALIDATION (FIRST!)
    # ============================================
    {% set bedtemp = params.get('BED') | int %}
    {% set hotendtemp = params.get('HOTEND') | int %}
    {% set chambertemp = params.get('CHAMBER', 0) | int %}
    {% set extruder = params.EXTRUDER|default(0)|int %}
    
    # Temperature validation
    {% if bedtemp < 0 or bedtemp > 150 %}
        {action_respond_error("ERROR: Invalid bed temperature: " ~ bedtemp)}
    {% endif %}
    {% if hotendtemp < 0 or hotendtemp > 350 %}
        {action_respond_error("ERROR: Invalid hotend temperature: " ~ hotendtemp)}
    {% endif %}
    {% if chambertemp < 0 or chambertemp > 100 %}
        {action_respond_error("ERROR: Invalid chamber temperature: " ~ chambertemp)}
    {% endif %}
    
    # ============================================
    # START BED AND CHAMBER HEATING IMMEDIATELY!
    # (Parallel to other operations - saves time)
    # ============================================
    M140 S{bedtemp}      # Start bed heating (non-blocking) - IMMEDIATELY!
    M141 S{chambertemp}  # Start chamber heating (non-blocking) - IMMEDIATELY!
    
    # ============================================
    # INITIALIZATION AND STATE RESET
    # (Executes in parallel with bed heating)
    # ============================================
    SAVE_VARIABLE VARIABLE=qdc_ai_error_code VALUE='""'
    AUTOTUNE_SHAPERS
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    
    # ============================================
    # PREPARATION: HOTEND OFF AND FANS
    # ============================================
    M104 S0  # Turn off hotend for safety
    
    # Chamber fan control
    {% if chambertemp == 0 %}
        M106 P3 S255  # Turn on chamber fan if chamber is not used
    {% else %}
        M106 P3 S0    # Turn off fan if chamber is used
    {% endif %}
    
    # ============================================
    # PRIMARY HOMING (at room temperature)
    # ============================================
    G28  # Home all axes
    SET_GCODE_OFFSET Z=0 MOVE=0  # Reset Z offset
    
    # ============================================
    # NOZZLE CLEANING AND FILAMENT CUTTING
    # ============================================
    CLEAR_NOZZLE HOTEND={hotendtemp}
    CUT_FILAMENT_1
    
    # Pre-heat hotend to 140°C for cutting
    # (140°C is sufficient for most materials for safe cutting)
    M104 S140
    G4 P15000  # Optimized: 15 seconds instead of 30 (material already partially heated)
    M400       # Wait for all commands to complete
    
    # ============================================
    # SECONDARY HOMING AND CALIBRATION
    # (after cutting, at 140°C - for precision after mechanical operations)
    # ============================================
    G28  # Home after cutting (important for positioning accuracy)
    Z_TILT_ADJUST  # Bed tilt calibration
    
    # ============================================
    # WAIT FOR TEMPERATURES
    # ============================================
    # Parallel waiting for bed and chamber (saves time)
    M190 S{bedtemp}      # Wait for bed temperature (blocking)
    M191 S{chambertemp}  # Wait for chamber temperature (blocking)
    M400                 # Ensure all commands are executed
    
    # Short pause for temperature stabilization (optimized)
    G4 P5000  # 5 seconds instead of 60 - sufficient for stabilization
    
    # ============================================
    # BED AUTO-CALIBRATION
    # ============================================
    G29  # Bed auto-calibration (BLTouch/Probe)
    
    # ============================================
    # MOVE TO START POSITION
    # ============================================
    G0 Z50 F600      # Raise Z for safety
    G0 X260 Y5 F6000 # Move to start position
    
    # ============================================
    # FINAL HOTEND HEATING TO WORKING TEMPERATURE
    # ============================================
    # M109 already waits for temperature, additional M191 not needed
    M109 S{hotendtemp}  # Heat and wait for hotend working temperature
    
    # ============================================
    # FINALIZATION
    # ============================================
    # Acceleration setting (if needed for specific print)
    # IMPORTANT: This may overwrite slicer settings!
    # If slicer already sets acceleration, this line can be removed
    # M204 S10000
    
    set_zoffset        # Set Z offset
    ENABLE_ALL_SENSOR  # Enable all sensors
    save_last_file     # Save file information
    
    # Ready notification
    {action_respond_info("PRINT_START: Printer ready for printing")}

