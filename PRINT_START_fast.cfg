# ============================================
# OPTIMIZED PRINT_START MACRO - FAST VERSION
# Firmware: Klipper v1.1.0
# Execution time: ~3-4 minutes
# Single homing (G28) instead of dual for speed
# ============================================

[gcode_macro PRINT_START]
gcode:
    # ============================================
    # PARAMETER VALIDATION (FIRST!)
    # ============================================
    {% set bedtemp = params.get('BED') | int %}
    {% set hotendtemp = params.get('HOTEND') | int %}
    {% set chambertemp = params.get('CHAMBER', 0) | int %}
    {% set extruder = params.EXTRUDER|default(0)|int %}
    
    # Temperature validation
    {% if bedtemp < 0 or bedtemp > 150 or hotendtemp < 0 or hotendtemp > 350 or chambertemp < 0 or chambertemp > 100 %}
        {action_respond_error("ERROR: Invalid temperature parameters")}
    {% endif %}
    
    # ============================================
    # START BED AND CHAMBER HEATING IMMEDIATELY!
    # ============================================
    M140 S{bedtemp}      # Start bed heating (non-blocking) - IMMEDIATELY!
    M141 S{chambertemp}  # Start chamber heating (non-blocking) - IMMEDIATELY!
    
    # ============================================
    # INITIALIZATION (parallel to heating)
    # ============================================
    SAVE_VARIABLE VARIABLE=qdc_ai_error_code VALUE='""'
    AUTOTUNE_SHAPERS
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    
    M104 S0
    {% if chambertemp == 0 %}
        M106 P3 S255
    {% else %}
        M106 P3 S0
    {% endif %}
    
    # ============================================
    # SINGLE HOMING (sufficient)
    # ============================================
    G28
    SET_GCODE_OFFSET Z=0 MOVE=0
    
    # ============================================
    # CLEANING AND FILAMENT CUTTING
    # ============================================
    CLEAR_NOZZLE HOTEND={hotendtemp}
    CUT_FILAMENT_1
    
    # Fast heating for cutting
    M104 S140
    G4 P10000  # 10 seconds is sufficient
    M400
    
    # ============================================
    # CALIBRATION
    # ============================================
    Z_TILT_ADJUST
    
    # ============================================
    # WAIT FOR TEMPERATURES
    # ============================================
    M190 S{bedtemp}
    M191 S{chambertemp}
    M400
    G4 P3000  # 3 seconds for stabilization
    
    # ============================================
    # AUTO-CALIBRATION
    # ============================================
    G29
    
    # ============================================
    # START POSITION
    # ============================================
    G0 Z50 F600
    G0 X260 Y5 F6000
    
    # ============================================
    # FINAL HEATING
    # ============================================
    M109 S{hotendtemp}
    
    # ============================================
    # FINALIZATION
    # ============================================
    set_zoffset
    ENABLE_ALL_SENSOR
    save_last_file
    
    {action_respond_info("PRINT_START: Ready for printing")}

